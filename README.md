# lb-csi plugin

## Deployment Bundle

We provide deployment examples for `lb-csi-plugin` and workloads that utilize it [here](deploy/README.md)

## Versioning

There are two Makefiles, one external and one for Lightbits.

* `Makefile.lb` - internal use.
* `Makefile` - external use.

### External Build

When we want to build an image for release we would want to tag the image with a meaningful immutable version.
This flow requires invocation of `Makefile` without any hash.

```bash
dockerize make
```

Makefile will detect there is no hash and will read the value off `VERSION` file
and will tag the image as:

```bash
lbdocker:5000/lb-csi-plugin:<version-tag>
```

Future improvements:

* Create a git tag with that version as well to be able to view this release easier.
* Add a `k8s` sanity test for the release-job CI job.

    Will validate against an `Ansible` deployed LightOS cluster.

    This job will use the Job BuildID to tag git as well as label and tag the Docker image docker the following format: `<VERSION>.<CI-JOB-ID>`

    Example:

    ```bash
    0.99.8.156
    ```

### Internal Build

CI and RnD will invoke `Makefile.lb` which will invoke `Makefile` with the `version.py` hash.

```bash
dockerize make -f Makefile.lb
```

This target will invoke `Makefile` with the `version.py` hash.

The result of this build will be a Docker image with the hash number and will be pushed to `lbdocker:5000`

Example tag of a CI/RnD build:

```bash
lbdocker:5000/lb-csi-plugin:7cc463e3ac54
```

**NOTE:** This build will be for internal use only - not exported to customers.

#### Docker image labels

```bash
LABEL version.lb-csi.hash=7cc463e3ac54
LABEL version.lb-csi.rel=0.99.8
LABEL version.nvme-cli.hash=4db6ca96aaa6
LABEL version.lb-csi.git=LightOS_2_0_0_beta1-22-g57eb4293-dirty
```

Use `docker inspect command to view image labels:

```bash
docker inspect lbdocker:5000/lb-csi-plugin:5d93e6c4cedf --format={{.ContainerConfig.Labels}}
```

##### `version.lb-csi.hash`

Hash version calculated by `version.py` - for R&D Lightbits internal use only.

##### `version.lb-csi.rel`

Version read from `VERSION` file.

##### `version.lb-csi.git`

Generated by following command:

```bash
git describe --tags --abbrev=8 --always --long --dirty
```

The way to read it is:

* `LightOS_2_0_0_beta1` - latest tag name.
* `22` - number of commits from that git tag.
* `g<hash>` - 8 char of short git sha.
* `dirty` - in case there are uncommitted changes in this workspace

This label was generated from the following repo state:

As you can see we have 22 commits after the tag which is the commit at the bottom.

```bash
57eb4293a9e1b043e6802c4bfb68466b671b130a (HEAD -> yogev/discovery-client) driver/node.go: add support for discovery-client configration
4683653db66f31fe21bf1c45d4f0f35b1e39e511 csi: add discovery_client util methods to manage DC config
637e884fac473479a9b333c879c2a64e9c19bca4 lb-csi-plugin-k8s-v1.15.yaml.template: add DS config folder.
1d7679861d1a06956581c5b2001269a287272920 .gitignore: add .vscode folder
d0aa58849e0bf9e1854b33b68a68a54d7ae2fc78 (origin/duros, m/master, duros) yaml: K8s v1.13 compatible deployment YAMLs
40e9c1e3162f83ba33e60b41bfbba49e75fae843 build,yaml: add init container to load nvme-tcp KLM
8ec06f1ed7eef9cd5e7af9eec088ae422191fb8e controller: initial ACLs support
966e9f91e89748f7fba980755f41634be6335b8e add empty VolumeId check to ParseCSIVolumeID()
e7e8bafc737b0ef8b912bc0650d0c54ec22852b0 node: use validateVolumeCapability() uniformly
caf6965ee356c7db006e869cbddd7ed020b633ac lbgrpc: test: add ACL smoke test to TestVolume()
9ae76deca776c4d2649d12861ce7d698f614a009 lbgrpc: test: set log level to debug
1b2147a1d7ad5f8676fff10cf9a632534bf3becc lbgrpc: test: reinstate vol size rounding check
4eb9138bdf09fc5fc26a68bf80382f65e6d1ae91 lbgrpc: LightOS API change: use ALLOW_NONE for empty ACLs
ab52be160e7b7fa118cf1e3119fb27fdf87dc249 lb,lbgrpc: add UpdateVolume() for ACLs updates
ac74808565dda3a014b7c16d4561c5a0cb307c9c lbgrpc: cap all calls, not just retries
5b658f357c058c22a4b547f86f30cdce4b3fff2f yaml: spiff up the deployment YAML template
4fbd6d41bfd6c390b23aa3b43e5aa50dd0088b45 lbgrpc: test: spin TestPollRemoteOk() out to manual test
59deb1ffbda7f32dfb66d7e1d71558b5786f735b add support for multiple mgmt API servers per cluster
cdd999d143f77428d46edbe4f273dd74cd0a0cb5 vendor: update gRPC to v1.29.1
e02de688937bba6589df8ad7f57e15b0e0bdf2de comments spelling
d9a0842784107dc0dfb9b5e8369270cba289888f lbgrpc: fix compression error formatting
cb1a78001023bff1b0f24daf6a22749a3d7d68ef build: optionally use local Docker registry for sidecars
9eb941a52e3e2e3b666e12593b52d483e66be832 (tag: v2.0.0, tag: LightOS_2_0_0_beta1) WIP: LightOS v2.0 beta API breakage updates
```
